<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Miguel Hern√°ndez - Autor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <style>
    body { -webkit-user-select: none; user-select: none; background-color: #f8f9fa; font-family: sans-serif; overflow-x: hidden; }
    .ig-verified { width: 16px; height: 16px; margin-left: 4px; color: #0095f6; display: inline-block; vertical-align: middle; }
    .watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 2.5rem; font-weight: bold; color: rgba(0,0,0,0.02); pointer-events: none; z-index: 10; white-space: nowrap; text-align: center; width: 100%; }
    .prose-serif { font-family: 'Georgia', serif; }
    #progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: rgba(0,0,0,0.05); z-index: 110; }
    #progress-bar { height: 100%; width: 0%; background: #0095f6; transition: width 0.3s ease; }
    .btn-nav { @apply bg-gray-100 text-gray-800 px-6 py-3 rounded-2xl text-xs font-bold uppercase tracking-widest active:scale-90 transition-all disabled:opacity-20; }
    .dot-online { width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; display: inline-block; }
    .cap-titulo {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: #1e40af;
      text-align: center;
      margin: 1.5rem 0;
      letter-spacing: 0.5px;
    }
    .sinopsis {
      font-size: 0.85rem;
      color: #4b5563;
      text-align: center;
      margin-top: 0.5rem;
      line-height: 1.4;
      font-style: italic;
    }
  </style>
</head>
<body oncontextmenu="return false;">

  <!-- Login (sin cambios) -->
  <div id="login-screen" class="fixed inset-0 bg-white z-[120] flex items-center justify-center p-6 transition-all duration-500">
    <div class="max-w-sm w-full text-center">
      <div class="w-20 h-20 bg-gray-900 rounded-3xl mx-auto mb-6 flex items-center justify-center text-white text-3xl font-bold shadow-2xl">MH</div>
      <h1 class="text-2xl font-bold text-gray-800 mb-2">Bienvenid@ a mi biblioteca beta</h1>
      <p class="text-gray-400 text-sm mb-6">Versi√≥n privada ‚Äì solo para quienes conocen el link üòâ</p>
      <input type="text" id="nombre-input" placeholder="Tu nombre o apodo" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-4 outline-none focus:border-blue-400">
      <button id="btn-entrar" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">Entrar</button>
      <p id="error-msg" class="text-red-500 text-xs mt-4 hidden">Por favor, escribe un nombre</p>
    </div>
  </div>

  <!-- Pantalla principal -->
  <div id="app-main" class="max-w-md mx-auto min-h-screen shadow-2xl bg-white hidden">
    <header class="p-10 text-center">
      <div class="w-24 h-24 bg-gray-100 rounded-full mx-auto mb-4 border-4 border-white shadow-md flex items-center justify-center overflow-hidden">
        <img src="https://i.ibb.co/jZ5cdq5w/Gemini-Generated-Image-jmfqjajmfqjajmfq.png" class="w-full h-full object-cover rounded-full" alt="Miguel Hern√°ndez">
      </div>
      <div class="flex items-center justify-center mb-1">
        <h1 class="text-xl font-bold text-gray-800">Miguel Hern√°ndez</h1>
        <svg class="ig-verified" viewBox="0 0 40 40" fill="currentColor">
          <path d="M19.998 3.132c-9.311 0-16.866 7.555-16.866 16.866s7.555 16.866 16.866 16.866 16.866-7.555 16.866-16.866-7.555-16.866-16.866-16.866zm8.217 14.12l-9.208 9.208a1.187 1.187 0 01-1.679 0l-4.524-4.524a1.187 1.187 0 111.679-1.679l3.684 3.684 8.37-8.37a1.187 1.187 0 011.678 1.681z"/>
        </svg>
      </div>
      <p id="bienvenida-personal" class="hidden">¬°Bienvenid@, Miguel! Gracias por estar aqu√≠.</p>
      <div class="flex items-center justify-center gap-2 mt-2">
        <span class="dot-online animate-pulse"></span>
        <span id="contador-activos" class="text-[9px] font-black text-gray-400 uppercase tracking-widest">1 Lector activo</span>
      </div>
      <button onclick="cerrarSesion()" class="text-[9px] text-gray-300 mt-6 border px-3 py-1 rounded-full">Cerrar Sesi√≥n</button>
    </header>

    <main class="p-6">
      <h2 class="text-[10px] font-black text-gray-300 uppercase tracking-widest mb-8 text-left">BIBLIOTECA PRIVADA</h2>
      <div id="contenedor-libros" class="grid grid-cols-2 gap-8"></div>
    </main>
  </div>

  <!-- Modal de valoraci√≥n -->
  <div id="valoracion-modal" class="fixed inset-0 bg-black/50 z-[130] hidden flex items-center justify-center">
    <div class="bg-white rounded-3xl p-8 max-w-md w-full m-4">
      <h2 class="text-2xl font-bold mb-4 text-center">Valora este libro</h2>
      <div id="modal-stars" class="flex justify-center gap-4 text-6xl mb-6"></div>
      <textarea id="modal-comentario" class="w-full p-5 border-2 border-gray-200 rounded-3xl text-lg resize-none h-32 mb-6" placeholder="Tu comentario (opcional)"></textarea>
      <div class="flex gap-4">
        <button id="btn-modal-enviar" class="flex-1 bg-blue-600 text-white py-4 rounded-3xl font-bold">Enviar</button>
        <button id="btn-modal-cancelar" class="flex-1 bg-gray-300 py-4 rounded-3xl font-bold">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Lector (sin cambios, mantengo el simple con botones) -->
  <div id="lector-libro" class="fixed inset-0 bg-white z-[105] hidden overflow-y-auto">
    <div id="progress-container"><div id="progress-bar"></div></div>
    <nav class="sticky top-0 bg-white/80 backdrop-blur-md p-4 flex justify-between items-center z-20">
      <button id="btn-cerrar" class="text-gray-400 text-sm font-bold">‚úï SALIR</button>
      <span class="text-[10px] font-black text-gray-300 uppercase tracking-widest">Lectura Protegida</span>
      <button id="btn-bookmark" class="text-2xl hover:text-yellow-500 transition">üîñ</button>
    </nav>
    <div class="watermark text-center">MIGUEL HERN√ÅNDEZ ‚Ä¢ ORIGINAL</div>
    <article class="max-w-prose mx-auto p-8 pt-10 pb-40">
      <h1 id="libro-titulo-display" class="text-4xl font-serif font-bold mb-4 text-gray-900 leading-tight"></h1>
      <div id="cap-actual-num" class="cap-titulo"></div>
      <div id="libro-texto" class="text-xl leading-[1.8] prose-serif text-gray-800 mb-20 whitespace-pre-line text-justify"></div>
      <div class="flex justify-between gap-4 py-10 border-t border-gray-100 mb-10">
        <button id="btn-ant" class="btn-nav flex-1">Anterior</button>
        <button id="btn-sig" class="btn-nav flex-1 bg-gray-900 text-white font-bold">Siguiente</button>
      </div>
    </article>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBLCRqrMUSMWJsJV0hWlapUvDZeOExcc6w",
      authDomain: "libreria-miguel.firebaseapp.com",
      projectId: "libreria-miguel",
      storageBucket: "libreria-miguel.firebasestorage.app",
      messagingSenderId: "490418742035",
      appId: "1:490418742035:web:38495fc41da972f8b070e6",
      databaseURL: "https://libreria-miguel-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rdb = getDatabase(app);

    let lectorNombre = localStorage.getItem('lector_nombre') || "";
    let listaCapitulos = [];
    let indiceActual = parseInt(localStorage.getItem('ultimo_cap_indice')) || 0;
    let idLibroActual = localStorage.getItem('ultimo_libro_id') || "";
    let tituloLibroActual = localStorage.getItem('ultimo_libro_titulo') || "";
    let currentRating = 0;
    let currentLibroId = "";

    window.onload = () => {
      if (lectorNombre) loginExitoso();
    };

    document.getElementById('btn-entrar').onclick = () => {
      const nombre = document.getElementById('nombre-input').value.trim();
      if (!nombre) { document.getElementById('error-msg').classList.remove('hidden'); return; }
      lectorNombre = nombre;
      localStorage.setItem('lector_nombre', nombre);
      loginExitoso();
    };

    function loginExitoso() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('app-main').classList.remove('hidden');
      document.getElementById('bienvenida-personal').textContent = `¬°Bienvenid@, ${lectorNombre}! Gracias por estar aqu√≠.`;
      document.getElementById('bienvenida-personal').classList.remove('hidden');
      cargarBiblioteca();
      activarPresencia();
    }

    function activarPresencia() {
      const idSesion = lectorNombre.replace(/[.#$[\]]/g, "_");
      const userRef = ref(rdb, 'activos/' + idSesion);
      set(userRef, { nombre: lectorNombre, conectado: true });
      onDisconnect(userRef).remove();
      onValue(ref(rdb, 'activos'), (snap) => {
        const total = snap.size || 1;
        document.getElementById('contador-activos').innerText = `${total} Lector${total > 1 ? 'es' : ''} en l√≠nea`;
      });
    }

    window.cerrarSesion = () => { localStorage.clear(); location.reload(); };

    async function cargarBiblioteca() {
      const querySnapshot = await getDocs(collection(db, "libros"));
      const contenedor = document.getElementById('contenedor-libros');
      contenedor.innerHTML = "";
      querySnapshot.forEach((doc) => {
        const libro = doc.data();
        const t = libro.titulo || libro.Titulo || "Sin T√≠tulo";
        const publicado = libro.publicado === true;

        let valoracionHTML = '';
        if (publicado) {
          // Placeholder por ahora (luego lo hacemos real con Firestore)
          valoracionHTML = `<p class="text-xs text-gray-600 text-center mt-1">4.5/5 (8 valoraciones)</p>`;
        }

        let html = `<div class="relative">`;
        html += `<div class="aspect-[2/3] bg-gray-100 rounded-[2rem] shadow-xl mb-4 overflow-hidden border-4 border-white relative">`;
        html += `<img src="${libro.portadaURL}" class="w-full h-full object-cover">`;
        if (!publicado) {
          html += `<div class="absolute inset-0 bg-black/60 flex items-center justify-center"><span class="text-white text-6xl">üîí</span></div>`;
          html += `</div><h3 class="font-bold text-sm text-gray-800 text-center">${t}</h3><p class="text-xs text-gray-500 text-center mt-1">Pr√≥ximamente</p>`;
        } else {
          html += `</div><h3 class="font-bold text-sm text-gray-800 text-center">${t}</h3>`;
          html += valoracionHTML;
          html = `<div class="cursor-pointer" onclick="prepararLectura('${doc.id}', '${t.replace(/'/g, "\\'")}')">${html}</div>`;
        }
        contenedor.innerHTML += html;
      });
    }

    window.prepararLectura = async (id, titulo) => {
      idLibroActual = id;
      tituloLibroActual = titulo;
      localStorage.setItem('ultimo_libro_id', id);
      localStorage.setItem('ultimo_libro_titulo', titulo);

      const q = query(collection(db, "libros", id, "capitulos"), orderBy("numero", "asc"));
      const snapshot = await getDocs(q);
      listaCapitulos = [];
      snapshot.forEach(doc => listaCapitulos.push(doc.data()));

      if (listaCapitulos.length === 0) {
        alert("Este libro no tiene cap√≠tulos.");
        return;
      }

      indiceActual = parseInt(localStorage.getItem(`ultimo_cap_${id}`)) || 0;
      mostrarCapitulo();

      document.getElementById('lector-libro').classList.remove('hidden');
      document.getElementById('app-main').classList.add('hidden');
    };

    function mostrarCapitulo() {
      if (indiceActual < 0 || indiceActual >= listaCapitulos.length) return;

      const cap = listaCapitulos[indiceActual];
      document.getElementById('libro-titulo-display').innerText = tituloLibroActual;
      document.getElementById('cap-actual-num').innerHTML = `<span class="cap-titulo">${cap.numero || indiceActual + 1}: ${cap.titulo || 'Cap√≠tulo sin t√≠tulo'}</span>`;
      document.getElementById('libro-texto').innerHTML = (cap.contenido || '<p class="text-gray-500">Contenido no disponible</p>').replace(/\n/g, '<br>');
      localStorage.setItem(`ultimo_cap_${idLibroActual}`, indiceActual);

      const progreso = ((indiceActual + 1) / listaCapitulos.length) * 100;
      document.getElementById('progress-bar').style.width = progreso + '%';

      document.getElementById('btn-ant').disabled = indiceActual === 0;
      document.getElementById('btn-sig').disabled = indiceActual === listaCapitulos.length - 1;

      document.getElementById('lector-libro').scrollTo(0,0);
    }

    document.getElementById('btn-ant').onclick = () => {
      if (indiceActual > 0) {
        indiceActual--;
        mostrarCapitulo();
      }
    };

    document.getElementById('btn-sig').onclick = () => {
      if (indiceActual < listaCapitulos.length - 1) {
        indiceActual++;
        mostrarCapitulo();
      }
    };

    document.getElementById('btn-bookmark').onclick = () => {
      localStorage.setItem(`bookmark_${lectorNombre}_${idLibroActual}`, indiceActual);
      alert("P√°gina marcada.");
    };

    document.getElementById('btn-cerrar').onclick = () => {
      document.getElementById('lector-libro').classList.add('hidden');
      document.getElementById('app-main').classList.remove('hidden');
    };
  </script>
</body>
</html>
